{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}User Account{% endblock %}</title>
    <script src="https://unpkg.com/htmx.org@1.9.6"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/flowbite@latest/dist/flowbite.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="{% static 'css/main.css' %}">
    <meta name="csrf-token" content="{{ csrf_token }}">
    <script src="https://cdn.jsdelivr.net/gh/alpinejs/alpine@v2.x.x/dist/alpine.min.js" defer></script>
</head>

<body class="bg-gray-100">

    <!-- Fixed Banner with Nav and Group Info -->
    <div class="fixed top-0 left-0 right-0 z-30 h-40" id="group-header">
        <!-- Background Image or Gradient -->
        {% if group.cover_image %}
        <div class="absolute inset-0 bg-cover bg-center" style="background-image: url('{{ group.cover_image.url }}');">
            <div class="absolute inset-0 bg-black bg-opacity-40"></div>
        </div>
        {% else %}
        <div class="absolute inset-0 bg-gradient-to-br from-blue-500 to-purple-600">
            <div class="absolute inset-0 bg-black bg-opacity-20"></div>
        </div>
        {% endif %}

        <!-- Nav Bar -->
        <nav class="relative z-10">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-16">
                    <div class="flex items-center">
                        <h1 class="text-xl font-bold text-orange-500">Chema</h1>
                    </div>
                    <div class="flex items-center space-x-4">
                        {% if user.is_authenticated %}
                        <a href="{% url 'profile' %}"
                            class="text-sm text-white bg-black/20 hover:bg-black/40 px-3 py-1.5 rounded-md transition-colors">
                            Welcome, {{ user.profile.first_name|default:user.email }}!
                        </a>
                        <div class="relative">
                            {% if user.profile.profile_picture %}
                            <img src="{{ user.profile.profile_picture.url }}" alt="Profile"
                                class="w-8 h-8 rounded-full object-cover border-2 border-white/50">
                            {% else %}
                            <div class="w-8 h-8 bg-gray-400 rounded-full flex items-center justify-center">
                                <span class="text-white text-sm font-medium">
                                    {{ user.email|first|upper }}
                                </span>
                            </div>
                            {% endif %}
                        </div>
                        <a href="{% url 'my_groups' %}"
                            class="text-sm text-white bg-black/20 hover:bg-black/40 px-3 py-1.5 rounded-md transition-colors">
                            My Groups
                        </a>
                        <a href="{% url 'logout' %}"
                            class="text-sm text-white bg-black/20 hover:bg-black/40 px-3 py-1.5 rounded-md transition-colors">
                            Logout
                        </a>
                        {% else %}
                        <a href="{% url 'login' %}"
                            class="text-sm text-white bg-black/20 hover:bg-black/40 px-3 py-1.5 rounded-md transition-colors">
                            Login
                        </a>
                        <a href="{% url 'register' %}"
                            class="text-sm text-white bg-black/20 hover:bg-black/40 px-3 py-1.5 rounded-md transition-colors">
                            Register
                        </a>
                        {% endif %}
                    </div>
                </div>
            </div>
        </nav>

        <!-- Group Info Section -->
        <div class="absolute bottom-0 left-0 right-0 text-white p-3">
            <div class="max-w-7xl mx-auto">
                <div class="flex items-end justify-between">
                    <div>
                        <div class="flex items-center space-x-4">
                            <h1 class="text-4xl font-bold mb-2">{{ group.name }}</h1>
                            <!-- Group Toggler Dropdown -->
                            <div class="relative" x-data="{ open: false }">
                                <button @click="open = !open" class="flex items-center text-white/80 hover:text-white transition-colors focus:outline-none">
                                    <i class="bi bi-chevron-down w-6 h-6"></i>
                                </button>
                                <div x-show="open" @click.away="open = false" class="absolute left-0 mt-2 w-72 bg-white rounded-lg shadow-xl z-20" style="display: none;">
                                    <div class="p-2 text-sm text-gray-500">Switch Group</div>
                                    <div class="border-t border-gray-100"></div>
                                    <div class="py-1">
                                        {% for user_group in user_groups %}
                                        <a href="{% url 'group_dashboard' %}?group_slug={{ user_group.slug }}" class="flex items-center px-4 py-2 text-gray-800 hover:bg-gray-100 {% if user_group.slug == group.slug %}bg-gray-100 font-semibold{% endif %}">
                                            {% if user_group.cover_image %}
                                            <img src="{{ user_group.cover_image.url }}" class="w-8 h-8 rounded-md object-cover mr-3">
                                            {% else %}
                                            <div class="w-8 h-8 rounded-md bg-gray-200 mr-3"></div>
                                            {% endif %}
                                            <span>{{ user_group.name }}</span>
                                            {% if user_group.slug == group.slug %}
                                            <i class="bi bi-check-circle-fill text-blue-500 ml-auto"></i>
                                            {% endif %}
                                        </a>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center space-x-4 text-white/90">
                            <div class="flex items-center">
                                <i class="bi bi-people-fill w-5 h-5 mr-2"></i>
                                {{ group.num_members }} member{{ group.num_members|pluralize }}
                            </div>
                            {% if group.city %}
                            <div class="flex items-center">
                                <i class="bi bi-geo-alt-fill w-5 h-5 mr-2"></i>
                                {{ group.city }}{% if group.country != "South Africa" %}, {{ group.country }}{% endif %}
                            </div>
                            {% endif %}
                            {% if group.is_online_only %}
                            <div class="flex items-center">
                                <i class="bi bi-globe w-5 h-5 mr-2"></i>
                                Online Group
                            </div>
                            {% endif %}
                            <button hx-get="{% url 'feeds:group_feed' slug=group.slug %}" hx-target="#group-related"
                                hx-swap="innerHTML" hx-indicator="#feed-loader"
                                class="flex items-center bg-fuchsia-500 text-white px-4 py-2 rounded-lg hover:bg-fuchsia-600 transition-colors">
                                <i class="bi bi-card-text mr-2"></i>
                                <span>Group Feeds</span>
                                <i id="feed-loader" class="bi bi-arrow-clockwise animate-spin ml-2 htmx-indicator"></i>
                            </button>
                            <button hx-get="{% url 'create_group' %}" hx-target="#group-related" hx-swap="innerHTML"
                                class="flex items-center bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors">
                                <i class="bi bi-plus-circle mr-2"></i>
                                <span>Create Group</span>
                            </button>
                            <button data-modal-target="about-group-modal" data-modal-toggle="about-group-modal"
                                class="flex items-center bg-gray-800 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition-colors">
                                <i class="bi bi-info-circle mr-2"></i>
                                <span>About Group</span>
                            </button>
                        </div>
                    </div>

                    {% if user.is_authenticated %}
                    {% if not user_membership %}
                    <button hx-get="{% url 'join_group' slug=group.slug %}" hx-target="#group-related"
                        hx-swap="innerHTML"
                        class="flex items-center justify-center bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 font-medium transition-colors">
                        <i class="bi bi-person-plus-fill mr-2"></i>
                        <span>Join Group</span>
                    </button>
                    {% elif user_membership.status == 'pending' %}
                    <span
                        class="flex items-center justify-center bg-yellow-600 text-white px-4 py-2 rounded-lg font-medium">
                        <i class="bi bi-hourglass-split mr-2"></i>
                        <span>Pending Approval</span>
                    </span>
                    {% elif user_membership.status == 'active' %}
                    {% if is_admin %}
                    <button hx-get="{% url 'group_manage' slug=group.slug %}" hx-target="#group-main-content"
                        hx-swap="innerHTML"
                        class="flex items-center justify-center bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 font-medium transition-colors">
                        <i class="bi bi-gear-fill mr-2"></i>
                        <span>Manage Group</span>
                    </button>
                    {% else %}
                    
                    {% endif %}
                    {% endif %}
                    {% else %}
                    <a href="{% url 'login' %}"
                        class="flex items-center justify-center bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 font-medium transition-colors">
                        <i class="bi bi-box-arrow-in-right mr-2"></i>
                        <span>Login to Join</span>
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content Area with Fixed Sidebar -->
    <div class="max-w-7xl mx-auto px-4 mt-8 pb-8" id="group-main-content" style="margin-top: 10rem;">
        <div class="flex gap-8">

            <!-- Fixed Left Sidebar -->
            <div class="w-80 flex-shrink-0">
                <div class="fixed w-80 space-y-6">
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Chema Hub</h3>
                        <div class="space-y-3">
                            {% include 'contributions/campaign_widget.html' %}

                            <button hx-get="{% url 'memorial:group_memorials' slug=group.slug %}"
                                hx-target="#group-related" hx-swap="innerHTML" hx-indicator="#memorials-loader"
                                class="flex items-center w-full text-left px-4 py-2 text-gray-700 hover:bg-gray-300 rounded-lg bg-gray-100">
                                <i class="bi bi-heart-fill w-5 h-5 mr-3 text-red-500"></i>
                                <span>Memorials</span>
                                {% if memorials_count %}
                                <span class="ml-auto bg-red-100 text-red-600 px-2 py-1 rounded-full text-xs">
                                    {{ memorials_count }}
                                </span>
                                {% endif %}
                                <i id="memorials-loader"
                                    class="bi bi-arrow-clockwise animate-spin ml-2 htmx-indicator"></i>
                            </button>

                            {% if group.contribution_campaign %}
                            <button hx-get="{% url 'contributions:campaign_detail' group_slug=group.slug %}"
                                hx-target="#group-related" hx-swap="innerHTML" hx-indicator="#campaign-loader"
                                class="flex items-center w-full text-left px-4 py-2 text-gray-700 hover:bg-gray-300 rounded-lg bg-gray-100">
                                <i class="bi bi-wallet2 w-5 h-5 mr-3 text-indigo-500"></i>
                                <span>Contribution Campaign</span>
                                <i id="campaign-loader"
                                    class="bi bi-arrow-clockwise animate-spin ml-auto htmx-indicator"></i>
                            </button>
                            {% endif %}

                            <button hx-get="{% url 'contributions:my_contributions' %}" hx-target="#group-related"
                                hx-swap="innerHTML" hx-indicator="#contributions-loader"
                                class="flex items-center w-full text-left px-4 py-2 text-gray-700 hover:bg-gray-300 rounded-lg bg-gray-100">
                                <i class="bi bi-cash-coin w-5 h-5 mr-3 text-blue-500"></i>
                                My Contributions
                            </button>

                            <button hx-get="{#}" hx-target="#group-related" hx-swap="innerHTML"
                                hx-indicator="#notifications-loader"
                                class="flex items-center w-full text-left px-4 py-2 text-gray-700 hover:bg-gray-300 rounded-lg bg-gray-100">
                                <i class="bi bi-bell-fill w-5 h-5 mr-3 text-yellow-500"></i>
                                Notifications
                            </button>

                            {% if is_admin %}
                            <button hx-get="{% url 'contributions:create_campaign' group.slug %}"
                                hx-target="#group-related" hx-swap="innerHTML" hx-indicator="#create-campaign-loader"
                                class="flex items-center w-full text-left px-4 py-2 text-gray-700 hover:bg-gray-300 rounded-lg bg-gray-100">
                                <i class="bi bi-plus-circle-fill w-5 h-5 mr-3 text-green-500"></i>
                                Create Campaign
                            </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Scrollable Main Content -->
            <div class="flex-1 min-h-screen" id="manage_group">
                <div id="group-related">
                    {% include 'feeds/_group_feed.html' %}
                </div>

                <!-- Main modal -->
                <div id="about-group-modal" tabindex="-1" aria-hidden="true"
                    class="hidden overflow-y-auto overflow-x-hidden fixed top-0 right-0 left-0 z-50 justify-center items-center w-full md:inset-0 h-modal md:h-full">
                    <div class="relative p-4 w-full max-w-2xl h-full md:h-auto">
                        <!-- Modal content -->
                        <div class="relative bg-white rounded-lg shadow">
                            <!-- Modal header -->
                            <div class="flex justify-between items-start p-4 rounded-t border-b">
                                <h3 class="text-xl font-semibold text-gray-900">
                                    About This Group
                                </h3>
                                <button type="button"
                                    class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm p-1.5 ml-auto inline-flex items-center"
                                    data-modal-toggle="about-group-modal">
                                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"
                                        xmlns="http://www.w3.org/2000/svg">
                                        <path fill-rule="evenodd"
                                            d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
                                            clip-rule="evenodd"></path>
                                    </svg>
                                </button>
                            </div>
                            <!-- Modal body -->
                            <div class="p-6">
                                <div class="prose prose-gray max-w-none">
                                    {{ group.description|linebreaks }}
                                </div>
                                <div class="space-y-3 mt-4 pt-4 border-t border-gray-200">
                                    {% if group.category %}
                                    <div class="flex items-center">
                                        <span class="text-gray-600 text-sm w-24 flex-shrink-0">Category:</span>
                                        <span class="text-sm">{{ group.category.icon }} {{ group.category.name }}</span>
                                    </div>
                                    {% endif %}

                                    <div class="flex items-center">
                                        <span class="text-gray-600 text-sm w-24 flex-shrink-0">Privacy:</span>
                                        <span class="text-sm capitalize">{{ group.privacy }}</span>
                                    </div>

                                    {% if group.max_members %}
                                    <div class="flex items-center">
                                        <span class="text-gray-600 text-sm w-24 flex-shrink-0">Capacity:</span>
                                        <span class="text-sm">{{ group.num_members }}/{{ group.max_members }}</span>
                                    </div>
                                    {% endif %}

                                    <div class="flex items-center">
                                        <span class="text-gray-600 text-sm w-24 flex-shrink-0">Approval:</span>
                                        <span class="text-sm">{% if group.requires_approval %}Required{% else %}Not
                                            Required
                                            {% endif %}</span>
                                    </div>

                                    <div class="flex items-center">
                                        <span class="text-gray-600 text-sm w-24 flex-shrink-0">Created:</span>
                                        <span class="text-sm">{{ group.created_at|date:"M d, Y" }}</span>
                                    </div>
                                </div>
                                {% if group.tag_list %}
                                <div class="mt-3 pt-6">
                                    <h3 class="text-sm font-medium text-gray-700 mb-3">Tags</h3>
                                    <div class="flex flex-wrap gap-2">
                                        {% for tag in group.tag_list %}
                                        <span
                                            class="bg-blue-50 text-blue-600 px-3 py-1 rounded-full text-sm">{{ tag }}</span>
                                        {% endfor %}
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                            <!-- Modal footer -->
                            <div
                                class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2 p-6 border-t border-gray-200 rounded-b">
                                <button onclick="copyGroupLink()"
                                    class="flex-1 flex items-center justify-center bg-gray-100 text-gray-700 px-3 py-2 rounded-lg hover:bg-gray-200 text-sm font-medium transition-colors">
                                    <i class="bi bi-clipboard mr-2"></i>
                                    <span>Copy Link</span>
                                </button>
                                <button onclick="shareGroup()"
                                    class="flex-1 flex items-center justify-center bg-blue-100 text-blue-700 px-3 py-2 rounded-lg hover:bg-blue-200 text-sm font-medium transition-colors">
                                    <i class="bi bi-share mr-2"></i>
                                    <span>Share</span>
                                </button>
                                <button hx-get="{% url 'browse_groups' %}" hx-target="#group-main-content" hx-swap="innerHTML"


                                    hx-indicator="#browse-loader" data-modal-toggle="about-group-modal"
                                    class="flex-1 flex items-center justify-center bg-green-100 text-green-700 px-3 py-2 rounded-lg hover:bg-green-200 text-sm font-medium transition-colors">
                                    <i id="browser-loader" class="hidden bi bi-loader"></i>
                                    <i class="bi bi-search mr-2"></i>
                                    <span>Browse Groups</span>
                                </button>
                                <button
                                    hx-get="{% url 'leave_group' slug=group.slug %}" hx-target="#group-related"
                                    hx-swap="innerHTML" data-modal-toggle="about-group-modal"
                                    class="flex items-center justify-center bg-red-200 text-red-700 px-4 py-2 rounded-lg hover:bg-red-300 font-medium transition-colors">
                                    <i class="bi bi-box-arrow-right mr-2"></i>
                                    <span>Leave Group</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // HTMX: Add CSRF token to all requests
        document.body.addEventListener('htmx:configRequest', function (event) {
            event.detail.headers['X-CSRFToken'] = document.querySelector('meta[name="csrf-token"]').content;
        });

        // Functions for copy/share
        function copyGroupLink() {
            navigator.clipboard.writeText(window.location.href).then(function () {
                alert('Group link copied to clipboard!');
            });
        }

        function shareGroup() {
            const url = window.location.href;
            const title = "{{ group.name|escapejs }}";
            if (navigator.share) {
                navigator.share({
                    title: title,
                    text: "Check out the '{{ group.name|escapejs }}' group!",
                    url: url,
                });
            } else {
                alert('Sharing is not supported on this browser. You can copy the link instead.');
            }
        }

        // Re-attach JS event handlers after HTMX swaps
        document.body.addEventListener('htmx:afterSwap', function (evt) {
            var copyBtn = document.querySelector('button[onclick="copyGroupLink()"]');
            if (copyBtn) {
                copyBtn.onclick = copyGroupLink;
            }
            var shareBtn = document.querySelector('button[onclick="shareGroup()"]');
            if (shareBtn) {
                shareBtn.onclick = shareGroup;
            }
        });

        // Store a global reference to the active HTMX modal instance
        window.htmxModalInstance = null;

        // Re-initialize Flowbite after HTMX swaps
        document.body.addEventListener('htmx:afterSwap', function (event) {
            if (window.initFlowbite) {
                if (event.detail.target.id === 'htmx-modal-content') {
                    const modalEl = document.getElementById('htmx-modal');
                    if (modalEl) {
                        const instanceId = `htmx-modal-${Date.now()}`;
                        modalEl.setAttribute('data-modal-id', instanceId);

                        const modalOptions = {
                            placement: 'center',
                            backdrop: 'dynamic',
                            backdropClasses: 'bg-gray-900 bg-opacity-50 fixed inset-0 z-50',
                            closable: true,
                            onHide: () => {
                                const modalContent = document.getElementById('htmx-modal-content');
                                if (modalContent) {
                                    modalContent.innerHTML = `<div class="p-8 text-center"><p>Loading...</p></div>`;
                                }
                                document.querySelector(`[data-modal-backdrop="${instanceId}"]`)?.remove();
                            }
                        };
                        const modal = new Modal(modalEl, modalOptions, { id: instanceId, onHide: modalOptions.onHide });
                        window.htmxModalInstance = modal;
                        modal.show();
                    }
                }
                window.initFlowbite();
            }
        });

        // Pre-select post type in modal
        document.addEventListener('click', function (e) {
            const toggleButton = e.target.closest('[data-modal-toggle="create-post-modal"]');
            if (toggleButton && toggleButton.dataset.postType) {
                const postType = toggleButton.dataset.postType;
                const modal = document.getElementById('create-post-modal');
                if (modal) {
                    const postTypeSelect = modal.querySelector('select[name="post_type"]');
                    if (postTypeSelect) {
                        postTypeSelect.value = postType;
                    }
                }
            }
        });

        function toggleReplyForm(commentId) {
            const form = document.getElementById('reply-form-' + commentId);
            if (form) {
                form.classList.toggle('hidden');
                if (!form.classList.contains('hidden')) {
                    form.querySelector('textarea').focus();
                }
            }
        }

        function sharePost(button) {
            const postUrl = button.dataset.postUrl;
            const postTitle = button.dataset.postTitle;
            const shareText = button.querySelector('.share-text');
            const successText = button.querySelector('.share-success-text');

            if (navigator.share) {
                navigator.share({
                    title: postTitle,
                    text: `Check out this post on Chema!`,
                    url: postUrl,
                })
                    .then(() => console.log('Successful share'))
                    .catch((error) => console.log('Error sharing', error));
            } else {
                navigator.clipboard.writeText(postUrl).then(function () {
                    if (shareText && successText) {
                        shareText.classList.add('hidden');
                        successText.classList.remove('hidden');
                        setTimeout(() => {
                            shareText.classList.remove('hidden');
                            successText.classList.add('hidden');
                        }, 2000);
                    }
                }, function (err) {
                    console.error('Could not copy text: ', err);
                    alert('Failed to copy link.');
                });
            }
        }

        // Lightbox JavaScript
        let currentPostMedia = [];
        let currentMediaIndex = 0;
        let currentPostId = null;

        function openLightbox(postId, startIndex) {
            collectPostMedia(postId);
            if (currentPostMedia.length === 0) return;

            currentMediaIndex = startIndex;
            currentPostId = postId;

            const lightbox = document.getElementById('media-lightbox');
            const prevBtn = document.getElementById('lightbox-prev');
            const nextBtn = document.getElementById('lightbox-next');

            if (currentPostMedia.length > 1) {
                prevBtn.classList.remove('hidden');
                nextBtn.classList.remove('hidden');
            } else {
                prevBtn.classList.add('hidden');
                nextBtn.classList.add('hidden');
            }

            loadMediaAtIndex(currentMediaIndex);
            lightbox.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        function collectPostMedia(postId) {
            currentPostMedia = [];
            const postContainer = document.querySelector(`[data-post-id="${postId}"]`);
            if (!postContainer) return;

            const mediaElements = postContainer.querySelectorAll('[data-media-url]');
            mediaElements.forEach(element => {
                currentPostMedia.push({
                    url: element.dataset.mediaUrl,
                    altText: element.dataset.mediaAlt || '',
                    type: element.dataset.mediaType || 'image',
                    caption: element.dataset.mediaCaption || ''
                });
            });
        }

        function loadMediaAtIndex(index) {
            if (index < 0 || index >= currentPostMedia.length) return;

            const media = currentPostMedia[index];
            const image = document.getElementById('lightbox-image');
            const video = document.getElementById('lightbox-video');
            const caption = document.getElementById('lightbox-caption');
            const counter = document.getElementById('lightbox-counter');
            const download = document.getElementById('lightbox-download');

            video.pause();
            video.currentTime = 0;

            if (media.type === 'image') {
                image.src = media.url;
                image.alt = media.altText;
                image.classList.remove('hidden');
                video.classList.add('hidden');
            } else if (media.type === 'video') {
                video.querySelector('source').src = media.url;
                video.load();
                video.classList.remove('hidden');
                image.classList.add('hidden');
            }

            caption.textContent = media.caption || media.altText || '';
            counter.textContent = currentPostMedia.length > 1 ? `${index + 1} / ${currentPostMedia.length}` : '';
            download.href = media.url;
            download.download = media.url.split('/').pop();
        }

        function closeLightbox() {
            const lightbox = document.getElementById('media-lightbox');
            const video = document.getElementById('lightbox-video');
            const image = document.getElementById('lightbox-image');

            video.pause();
            video.currentTime = 0;
            image.src = '';
            video.querySelector('source').src = '';

            lightbox.classList.add('hidden');
            document.body.style.overflow = 'auto';

            currentPostMedia = [];
            currentMediaIndex = 0;
            currentPostId = null;
        }

        function navigateLightbox(direction) {
            if (currentPostMedia.length === 0) return;
            currentMediaIndex = (currentMediaIndex + direction + currentPostMedia.length) % currentPostMedia.length;
            loadMediaAtIndex(currentMediaIndex);
        }

        // Keyboard navigation
        document.addEventListener('keydown', function (e) {
            const lightbox = document.getElementById('media-lightbox');
            if (!lightbox.classList.contains('hidden')) {
                e.preventDefault();
                if (e.key === 'Escape') closeLightbox();
                else if (e.key === 'ArrowLeft') navigateLightbox(-1);
                else if (e.key === 'ArrowRight') navigateLightbox(1);
            }
        });
    </script>

</body>

</html>