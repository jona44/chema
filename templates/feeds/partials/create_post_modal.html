<!----------------- Create Post Modal --------------->

<div id="create-post-modal" tabindex="-1" aria-hidden="true"
    class="fixed top-0 left-0 right-0 z-50 hidden w-full p-4 overflow-x-hidden overflow-y-auto md:inset-0 h-modal md:h-full">
    <div class="relative w-full h-full max-w-2xl md:h-auto">
        <div class="relative bg-white rounded-lg shadow">



            <!-------------- Modal Header ----------------->

            <div class="flex items-start justify-between p-4 border-b rounded-t">
                <h3 class="text-xl font-semibold text-gray-900">
                    Create Post
                </h3>
                <button type="button"
                    class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm p-1.5 ml-auto inline-flex items-center"
                    data-modal-hide="create-post-modal">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <!------------------ Modal Body --------------------->

            <div class="p-6 space-y-6">

                <!---------------- Author Info ---------------------->

                <div class="flex items-center space-x-3">
                    <div class="flex-shrink-0">
                        {% if user.profile.profile_picture %}
                        <img src="{{ user.profile.profile_picture.url }}" alt="Your profile picture"
                            class="h-10 w-10 rounded-full object-cover">
                        {% else %}
                        <div class="h-10 w-10 rounded-full bg-blue-500 flex items-center justify-center">
                            <span class="text-white font-medium text-sm">{{
                                user.profile.full_name.0|default:user.email.0|upper }}</span>
                        </div>
                        {% endif %}
                    </div>
                    <div>
                        <p class="font-medium text-gray-900">{{ user.profile.full_name|default:user.email }}</p>
                        <p class="text-sm text-gray-500">Posting to {{ group.name }}</p>
                    </div>
                </div>

                <!---------------- Post Form --------------------->

                <form hx-post="{% url 'feeds:create_post' group.slug %}" hx-target="#posts-container"
                    hx-swap="afterbegin" id="post-form" class="space-y-4">
                    {% csrf_token %}

                    <!------------------ Post Type Selection ------------->

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Post Type</label>
                        <select name="post_type"
                            class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                            <option value="text">Text Post</option>
                            <option value="photo">Photo</option>
                            <option value="link">Link Share</option>
                            <option value="question">Question</option>
                            <option value="announcement">Announcement</option>
                            {% if feed.allow_events %}
                            <option value="event">Event</option>
                            {% endif %}
                            {% if feed.allow_polls %}
                            <option value="poll">Poll</option>
                            {% endif %}
                        </select>
                    </div>

                    <!---------------------- Title (Optional) -------------->
                    <div>
                        <label for="post-title" class="block text-sm font-medium text-gray-700 mb-2">Title
                            (Optional)</label>
                        <input type="text" id="post-title" name="title"
                            class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5"
                            placeholder="Give your post a title...">
                    </div>

                    <!--------------------- Content -------------------->

                    <div>
                        <label for="post-content" class="block text-sm font-medium text-gray-700 mb-2">What's on your
                            mind?</label>
                        <textarea id="post-content" name="content" rows="4"
                            class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5"
                            placeholder="Share your thoughts with the group..." required></textarea>
                    </div>

                    <!---------------- Privacy Level ------------------->

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Who can see this?</label>
                        <select name="privacy_level"
                            class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                            <option value="public">Public to Group</option>
                            <option value="members_only">Members Only</option>
                            {% if is_admin %}
                            <option value="admins_only">Admins Only</option>
                            {% endif %}
                        </select>
                    </div>

                    <!------------ Additional Options -------------->

                    <div class="space-y-3">
                        <label class="flex items-center">
                            <input type="checkbox" name="is_urgent"
                                class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                            <span class="ml-2 text-sm text-gray-700">Mark as urgent</span>
                        </label>

                        {% if feed.allow_anonymous_posts %}
                        <label class="flex items-center">
                            <input type="checkbox" name="is_anonymous"
                                class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                            <span class="ml-2 text-sm text-gray-700">Post anonymously</span>
                        </label>
                        {% endif %}
                    </div>

                </form>

                <!-------------- Media Upload Area -------------->

                <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center">
                    <i class="fas fa-cloud-upload-alt text-gray-400 text-3xl mb-2"></i>
                    <p class="text-gray-500 mb-2">Add photos, videos or files</p>
                    <button class="text-blue-600 hover:underline text-sm">Choose files</button>
                </div>

            </div>

            <!-------------------- Modal Footer ---------------->

            <div class="flex items-center justify-between p-6 space-x-2 border-t border-gray-200 rounded-b">
                <div class="flex items-center space-x-4">
                    <button type="button" class="text-gray-500 hover:text-blue-600 transition-colors">
                        <i class="far fa-image text-xl"></i>
                    </button>
                    <button type="button" class="text-gray-500 hover:text-purple-600 transition-colors">
                        <i class="fas fa-poll text-xl"></i>
                    </button>
                    <button type="button" class="text-gray-500 hover:text-green-600 transition-colors">
                        <i class="far fa-calendar text-xl"></i>
                    </button>
                    <button type="button" class="text-gray-500 hover:text-orange-600 transition-colors">
                        <i class="fas fa-map-marker-alt text-xl"></i>
                    </button>
                </div>

                <div class="flex space-x-2">
                    <button type="button" data-modal-hide="create-post-modal"
                        class="text-gray-500 bg-white hover:bg-gray-100 focus:ring-4 focus:outline-none focus:ring-blue-300 rounded-lg border border-gray-200 text-sm font-medium px-5 py-2.5 hover:text-gray-900 focus:z-10">
                        Cancel
                    </button>
                    <button type="submit" form="post-form"
                        class="text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center">
                        Post
                    </button>
                </div>
            </div>

        </div>
    </div>
</div>

<!------------- Add JS for Flowbite modal backdrop fix---- -->
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const modalElement = document.getElementById('create-post-modal');
        if (!modalElement) {
            return;
        }

        // Enhanced backdrop removal function
        function removeAllBackdrops() {
            const backdrops = document.querySelectorAll([
                '[data-modal-backdrop]',
                '.modal-backdrop',
                '[modal-backdrop]',
                '.fixed.inset-0.bg-gray-900',
                '.bg-opacity-50.fixed.inset-0'
            ].join(', '));

            backdrops.forEach(backdrop => {
                backdrop.remove();
            });

            document.querySelectorAll('.z-40').forEach(el => {
                if (el.classList.contains('fixed') && el.classList.contains('inset-0')) {
                    el.remove();
                }
            });

            document.body.style.overflow = '';
            document.body.classList.remove('overflow-hidden');
        }

        function aggressiveBackdropCleanup() {
            removeAllBackdrops();
            const timeouts = [50, 100, 200, 500, 1000];
            timeouts.forEach(delay => {
                setTimeout(removeAllBackdrops, delay);
            });
        }

        // Modal setup
        const modalOptions = {
            placement: 'center',
            backdrop: 'dynamic',
            backdropClasses: 'bg-gray-900 bg-opacity-50 fixed inset-0 z-40',
            closable: true,
            onHide: () => {
                const form = document.getElementById('post-form');
                if (form) {
                    form.reset();
                }
                aggressiveBackdropCleanup();
            }
        };

        const createPostModal = new Modal(modalElement, modalOptions);

        // Function to close modal
        function closeModal() {
            createPostModal.hide();
            setTimeout(() => {
                modalElement.classList.add('hidden');
                modalElement.setAttribute('aria-hidden', 'true');
                aggressiveBackdropCleanup();
            }, 50);
        }

        // Listen for HTMX events
        document.body.addEventListener('htmx:afterRequest', function (event) {
            if (event.target.id === 'post-form') {
                console.log('HTMX Request completed:', event.detail);

                // Check if request was successful (status 200-299)
                if (event.detail.successful) {
                    console.log('Post created successfully, closing modal');
                    closeModal();
                } else {
                    console.log('Post creation failed');
                    // Optionally show error message
                    removeAllBackdrops(); // Clean up any stray backdrops
                }
            }
        });

        // Listen for custom HTMX trigger events from Django
        document.body.addEventListener('postCreated', function (event) {
            console.log('Post created event received');
            closeModal();
        });

        document.body.addEventListener('closeModal', function (event) {
            console.log('Close modal event received');
            closeModal();
        });

        // Alternative: Listen for successful HTMX swap
        document.addEventListener('htmx:afterSwap', function (event) {
            if (event.target.id === 'posts-container') {
                // Check if the swap came from our form
                const form = document.getElementById('post-form');
                if (form && event.detail.requestConfig &&
                    event.detail.requestConfig.elt === form) {
                    console.log('Post successfully added to feed, closing modal');
                    closeModal();
                }
            }
        });

        // Error handling
        document.body.addEventListener('htmx:responseError', function (event) {
            if (event.target.id === 'post-form') {
                console.log('HTMX Error:', event.detail);
                removeAllBackdrops();

                // Optionally show error message to user
                const errorMsg = document.createElement('div');
                errorMsg.className = 'bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4';
                errorMsg.textContent = 'Failed to create post. Please try again.';

                const formContainer = document.getElementById('post-form').parentElement;
                formContainer.insertBefore(errorMsg, document.getElementById('post-form'));

                // Remove error message after 5 seconds
                setTimeout(() => errorMsg.remove(), 5000);
            }
        });

        // Debugging function
        window.forceCloseModal = closeModal;
        window.debugModal = function () {
            console.log('Modal element:', modalElement);
            console.log('Modal classes:', modalElement.className);
            console.log('Backdrops found:', document.querySelectorAll('[data-modal-backdrop], .modal-backdrop').length);
        };
    });
</script>