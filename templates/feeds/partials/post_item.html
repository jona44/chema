{% load feed_tags %}
<div id="post-{{ post.id }}" class="bg-gray-200 rounded-lg shadow mb-6 transition-all duration-200">

    <!------------ Post Header --------------->
    <div class="p-4 border-b border-gray-100">
        <div class="flex items-start justify-between">
            <div class="flex items-start space-x-3">

                <!------------ Author Avatar ---------->

                <div class="flex-shrink-0">
                    {% if post.is_anonymous %}
                        <div class="h-10 w-10 rounded-full bg-gray-400 flex items-center justify-center">
                            <span class="text-white font-bold text-lg">?</span>
                        </div>
                    {% elif post.author.profile and post.author.profile.profile_picture %}
                        <img src="{{ post.author.profile.profile_picture.url }}" alt="{% if post.author.profile %}{{ post.author.profile.full_name }}{% endif %}"
                            class="h-10 w-10 rounded-full object-cover">
                    {% else %}
                        <div class="h-10 w-10 rounded-full bg-blue-500 flex items-center justify-center">
                            <span class="text-white font-medium text-sm">
                                {% if post.author.profile %}
                                    {{ post.author.profile.full_name|first|default:post.author.email|first|upper }}
                                {% else %}
                                    {{ post.author.email|first|upper }}
                                {% endif %}
                            </span>
                        </div>
                    {% endif %}
                </div>

                <!---------------- Author Info --------->

                <div class="flex-1">
                    <div class="flex items-center space-x-2">
                        <h4 class="text-sm font-semibold text-gray-900">
                            {% if post.is_anonymous %}
                                Anonymous
                            {% elif post.author.profile %}
                                {{ post.author.profile.full_name|default:post.author.email }}
                            {% else %}
                                {{ post.author.email }}
                            {% endif %}
                        </h4>

                        <!-------------------- Post Type Badge ---------------->

                        {% if post.post_type != 'text' %}
                        <span
                            class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-800">
                            <i
                                class="fas fa-{% if post.post_type == 'photo' %}image{% elif post.post_type == 'video' %}video{% elif post.post_type == 'link' %}link{% elif post.post_type == 'poll' %}poll-h{% elif post.post_type == 'event' %}calendar{% else %}file-alt{% endif %} mr-1"></i>
                            {{ post.get_post_type_display }}
                        </span>
                        {% endif %}

                        <!------------ Pinned Badge ------------>

                        {% if post.is_pinned %}
                        <span
                            class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-yellow-100 text-yellow-800">
                            <i class="fas fa-thumbtack mr-1"></i>
                            Pinned
                        </span>
                        {% endif %}

                        <!----------------------- Urgent Badge ---------------------->

                        {% if post.is_urgent %}
                        <span
                            class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-red-100 text-red-800">
                            <i class="fas fa-exclamation mr-1"></i>
                            Urgent
                        </span>
                        {% endif %}
                    </div>

                    <div class="flex items-center space-x-2 mt-1">
                        <p class="text-xs text-gray-500">{{ post.created_at|timesince }} ago</p>

                        <!-------------------- Privacy Level ------------------------>

                        <span class="text-gray-400">â€¢</span>
                        <div class="flex items-center text-xs text-gray-500">
                            <i
                                class="fas fa-{% if post.privacy_level == 'public' %}globe{% elif post.privacy_level == 'members_only' %}users{% elif post.privacy_level == 'admins_only' %}lock{% else %}heart{% endif %} mr-1"></i>
                            {{ post.get_privacy_level_display }}
                        </div>
                    </div>
                </div>
            </div>

            <!----------------- Post Actions Dropdown ---------------->

            {% if post.can_edit %}
            <div class="relative">
                <button class="text-gray-400 hover:text-gray-600" data-dropdown-toggle="post-{{ post.id }}-dropdown">
                    <i class="fas fa-ellipsis-h"></i>
                </button>
                <div id="post-{{ post.id }}-dropdown"
                    class="z-10 hidden bg-white divide-y divide-gray-100 rounded-lg shadow w-44">
                    <ul class="py-2 text-sm text-gray-700">
                        <li>
                            <a href="#" class="block px-4 py-2 hover:bg-gray-100">
                                <i class="fas fa-edit mr-2"></i>Edit Post
                            </a>
                        </li>
                        {% if post|can_delete:user %}
                        <li>
                            <button hx-delete="{% url 'feeds:delete_post' post.id %}"
                                hx-confirm="Are you sure you want to delete this post?" hx-target="#post-{{ post.id }}"
                                hx-swap="outerHTML"
                                class="block w-full text-left px-4 py-2 hover:bg-gray-100 text-red-600">
                                <i class="fas fa-trash mr-2"></i>Delete Post
                            </button>
                        </li>
                        {% endif %}
                    </ul>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <!----- Post Content --------->
    <div class="p-4">
        <!--------- Title ------------>

        {% if post.title %}
        <h3 class="text-lg font-semibold text-gray-900 mb-2">{{ post.title }}</h3>
        {% endif %}

        <!-------- Content----- -->

        <div class="text-gray-700 leading-relaxed mb-4">
            {{ post.content|linebreaks }}
        </div>

        <!---------------- Link Preview -------->

        {% if post.link_url %}
        <div class="border border-gray-200 rounded-lg overflow-hidden mb-4">
            {% if post.link_image %}
            <img src="{{ post.link_image }}" alt="{{ post.link_title }}" class="w-full h-48 object-cover">
            {% endif %}
            <div class="p-4">
                <h4 class="font-semibold text-gray-900 mb-1">{{ post.link_title }}</h4>
                <p class="text-gray-600 text-sm mb-2">{{ post.link_description|truncatewords:20 }}</p>
                <a href="{{ post.link_url }}" target="_blank" class="text-blue-600 hover:underline text-sm">
                    {{ post.link_url|truncatechars:50 }}
                    <i class="fas fa-external-link-alt ml-1"></i>
                </a>
            </div>
        </div>
        {% endif %}

        <!----------------- Event Details ----------------------->

        {% if post.post_type == 'event' and post.event_date %}
        <div class="bg-blue-50 rounded-lg p-4 mb-4">
            <div class="flex items-center space-x-3">
                <div class="flex-shrink-0">
                    <i class="fas fa-calendar-alt text-blue-600 text-lg"></i>
                </div>
                <div>
                    <p class="font-semibold text-gray-900">{{ post.event_date|date:"F d, Y \a\t g:i A" }}</p>
                    {% if post.event_end_date %}
                    <p class="text-sm text-gray-600">Until {{ post.event_end_date|date:"F d, Y \a\t g:i A" }}</p>
                    {% endif %}
                    {% if post.location %}
                    <p class="text-sm text-gray-600">
                        <i class="fas fa-map-marker-alt mr-1"></i>{{ post.location }}
                    </p>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endif %}

        <!------------- Media Attachments ------------>
        <div id="like-button-{{ post.id }}">
            {% include 'feeds/partials/lightbox_media_post.html' with post=post user=user %}
        </div>

        <!---------------- Post Stats ----------------->

        <div class="px-4 py-2 border-t border-gray-100">
            <div class="flex items-center justify-between text-sm text-gray-500">
                <div class="flex items-center space-x-4">
                    {% if post.likes_count > 0 %}
                    <span class="flex items-center">
                        <i class="fas fa-thumbs-up text-blue-600 mr-1"></i>
                        {{ post.likes_count }}
                    </span>
                    {% endif %}

                    {% if post.comments_count > 0 %}
                    <span>{{ post.comments_count }} comment{{ post.comments_count|pluralize }}</span>
                    {% endif %}

                    {% if post.shares_count > 0 %}
                    <span>{{ post.shares_count }} share{{ post.shares_count|pluralize }}</span>
                    {% endif %}
                </div>

                <div class="flex items-center space-x-2">
                    <span>{{ post.views_count }} view{{ post.views_count|pluralize }}</span>
                </div>
            </div>
        </div>

        <!----------------- Post Actions ----------->

        <div class="px-4 py-3 border-t border-gray-100">
            <div class="flex items-center justify-between">

                <!----------- Like Button ----------->

                <div id="like-button-{{ post.id }}">
                    {% include 'feeds/partials/like_button.html' with post=post user=user %}
                </div>

                <!------------ Comment Button ---------->

                <button hx-get="{% url 'feeds:load_comments' post.id %}" hx-target="#htmx-modal-content"
                    hx-swap="innerHTML" data-modal-target="htmx-modal" data-modal-toggle="htmx-modal"
                    class="flex items-center space-x-2 px-4 py-2 text-gray-500 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition-colors">
                    <i class="far fa-comment"></i>
                    <span>Comment</span>
                </button>

                <!--------------- Share Button ---------->

                <button onclick="sharePost(this)"
                    data-post-url="{{ request.scheme }}://{{ request.get_host }}{{ post.feed.group.get_absolute_url }}#post-{{ post.id }}"
                    data-post-title="{{ post.title|default:'A post from '|add:post.feed.group.name }}"
                    class="flex items-center space-x-2 px-4 py-2 text-gray-500 hover:text-green-600 hover:bg-green-50 rounded-lg transition-colors">
                    <i class="far fa-share"></i>
                    <span class="share-text">Share</span>
                    <span class="share-success-text hidden text-green-600">Copied!</span>
                </button>

            </div>
        </div>

        <!--------------- Quick Comments Preview ------------->

        {% if post.comments_count > 0 %}
        <div class="px-4 pb-4">
            <div class="bg-gray-300 rounded-lg p-3">
                <div class="space-y-2">
                    {% for comment in post.comments.all|slice:":3" %}
                    <div class="flex items-start space-x-2">
                        <div class="flex-shrink-0">
                            {% if comment.author.profile and comment.author.profile.profile_picture %}
                                <img src="{{ comment.author.profile.profile_picture.url }}"
                                    alt="{% if comment.author.profile %}{{ comment.author.profile.full_name }}{% endif %}" class="h-6 w-6 rounded-full object-cover">
                            {% else %}
                                <div class="h-6 w-6 rounded-full bg-gray-400 flex items-center justify-center">
                                    <span class="text-white text-xs">
                                        {% if comment.author.profile %}
                                            {{ comment.author.profile.full_name|first|default:comment.author.email|first|upper }}
                                        {% else %}
                                            {{ comment.author.email|first|upper }}
                                        {% endif %}
                                    </span>
                                </div>
                            {% endif %}
                        </div>
                        <div class="flex-1">
                            <p class="text-sm">
                                <span class="font-medium text-gray-900">
                                    {% if comment.author.profile %}
                                        {{ comment.author.profile.full_name|default:comment.author.email }}
                                    {% else %}
                                        {{ comment.author.email }}
                                    {% endif %}
                                </span>
                                <span class="text-gray-700">{{ comment.content|truncatewords:15 }}</span>
                            </p>
                        </div>
                    </div>
                    {% endfor %}

                    {% if post.comments_count > 2 %}
                    <button hx-get="{% url 'feeds:load_comments' post.id %}" hx-target="#htmx-modal-content"
                        hx-swap="innerHTML" data-modal-target="htmx-modal" data-modal-toggle="htmx-modal"
                        class="text-sm text-blue-600 hover:underline">
                        View all {{ post.comments_count }} comments
                    </button>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endif %}

    </div>
</div>
