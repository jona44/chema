<div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4 mb-6">
    <div class="flex items-center justify-between mb-4">
        <h3 class="text-sm font-medium text-gray-900">Share with the group</h3>
        <span class="text-xs text-gray-500">{{ group.name }}</span>
    </div>

    {# ---------------------------------------------------------------- #}
    {# Memorial-Specific Post Options #}
    {# ---------------------------------------------------------------- #}

    {% if group.memorial %}
    <div class="bg-gradient-to-r from-purple-50 to-indigo-50 rounded-lg p-4 mb-4 border border-purple-200 ">
        <h4 class="text-sm font-medium text-purple-900 mb-3 flex items-center">
            <i class="bi bi-heart-fill w-4 h-4 mr-2"></i>
            Memorial Posts for {{ group.memorial.deceased_name }}
        </h4>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-2 ">
            <button type="button" hx-get="{% url 'feeds:memory_modal' group.slug %}" hx-target="#htmx-modal-content"
                hx-swap="innerHTML" data-modal-target="htmx-modal" data-modal-toggle="htmx-modal"
                class="flex flex-col items-center p-3 border border-purple-200 rounded-lg hover:border-indigo-400 hover:bg-indigo-50 transition-colors group">
                <i class="bi bi-heart-half w-5 h-5 text-purple-400 group-hover:text-indigo-500 mb-1"></i>
                <span class="text-xs font-medium text-gray-700 group-hover:text-indigo-700">Memorial</span>
            </button>

            <button type="button" hx-get="{% url 'feeds:condolence_modal' group.slug %}" hx-target="#htmx-modal-content"
                hx-swap="innerHTML" data-modal-target="htmx-modal" data-modal-toggle="htmx-modal"
                class="flex flex-col items-center p-3 border border-purple-200 rounded-lg hover:border-purple-400 hover:bg-purple-50 transition-colors group">
                <i class="bi bi-book w-5 h-5 text-purple-400 group-hover:text-purple-500 mb-1"></i>
                <span class="text-xs font-medium text-gray-700 group-hover:text-purple-700">Condolence</span>
            </button>

            <button type="button" hx-get="{% url 'feeds:tribute_modal' group.slug %}" hx-target="#htmx-modal-content"
                hx-swap="innerHTML" data-modal-target="htmx-modal" data-modal-toggle="htmx-modal"
                class="flex flex-col items-center p-3 border border-purple-200 rounded-lg hover:border-pink-400 hover:bg-pink-50 transition-colors group">
                <i class="bi bi-star-fill w-5 h-5 text-purple-400 group-hover:text-pink-500 mb-1"></i>
                <span class="text-xs font-medium text-gray-700 group-hover:text-pink-700">Tribute</span>
            </button>


            <button type="button" hx-get="{% url 'feeds:funeral_update_modal' group.slug %}"
                hx-target="#htmx-modal-content" hx-swap="innerHTML" data-modal-target="htmx-modal"
                data-modal-toggle="htmx-modal"
                class="flex flex-col items-center p-3 border border-purple-200 rounded-lg hover:border-gray-400 hover:bg-orange-50 transition-colors group">
                <i class="bi bi-clock-history w-5 h-5 text-purple-400 group-hover:text-orange-600 mb-1"></i>
                <span class="text-xs font-medium text-black-700 group-hover:text-gray-700">Update</span>
            </button>

        </div>
    </div>
    {% endif %}

    {# ---------------------------------------------------------------- #}
    {# Standard Group Post Options #}
    {# ---------------------------------------------------------------- #}
    <div class="grid grid-cols-2 md:grid-cols-4 gap-3">

        {% if feed.allow_media %}
        <button type="button" 
            hx-get="{% url 'feeds:media_post_modal' group.slug %}" 
            hx-target="#htmx-modal-content"
            hx-swap="innerHTML" 
            data-modal-target="htmx-modal" 
            class="flex flex-col items-center p-4 border border-gray-200 rounded-lg hover:border-purple-300 hover:bg-purple-50 transition-colors group">
            <i class="bi bi-image w-6 h-6 text-gray-400 group-hover:text-purple-500 mb-2"></i>
            <span class="text-sm font-medium text-gray-700 group-hover:text-purple-700">Media</span>
            <span class="text-xs text-gray-500 mt-1">Photos & Videos</span>
        </button>
        {% endif %}

        {% if feed.allow_events %}
        <button type="button"
            hx-get="{% url 'feeds:event_modal' group.slug %}" 
            hx-target="#htmx-modal-content"
            hx-swap="innerHTML" 
            data-modal-target="htmx-modal" 
            class="flex flex-col items-center p-4 border border-gray-200 rounded-lg hover:border-green-300 hover:bg-green-50 transition-colors group">
            <i class="bi bi-calendar-plus w-6 h-6 text-gray-400 group-hover:text-green-500 mb-2"></i>
            <span class="text-sm font-medium text-gray-700 group-hover:text-green-700">Event</span>
            <span class="text-xs text-gray-500 mt-1">Schedule something</span>
        </button>
        {% endif %}


        <button type="button" 
            hx-get="{% url 'feeds:create_poll_post' group.slug %}" 
            hx-target="#htmx-modal-content"
            hx-swap="innerHTML" 
            data-modal-target="htmx-modal" 
            data-modal-toggle="htmx-modal"
            class="flex flex-col items-center p-4 border border-gray-200 rounded-lg hover:border-teal-300 hover:bg-teal-50 transition-colors group">
            <i class="bi bi-bar-chart-steps w-6 h-6 text-gray-400 group-hover:text-teal-500 mb-2"></i>
            <span class="text-sm font-medium text-gray-700 group-hover:text-teal-700">Poll</span>
            <span class="text-xs text-gray-500 mt-1">Ask the group</span>
        </button>



        <button type="button" 
            hx-get="{% url 'feeds:announcement_modal' group.slug %}" 
            hx-target="#htmx-modal-content"
            hx-swap="innerHTML" 
            data-modal-target="htmx-modal" 
            data-modal-toggle="htmx-modal"
            class="flex flex-col items-center p-2 border border-gray-200 rounded-lg hover:border-yellow-300 hover:bg-yellow-50 transition-colors group">
            <i class="bi bi-megaphone w-6 h-6 text-gray-400 group-hover:text-yellow-500 mb-2"></i>
            <span class="text-sm font-medium text-gray-700 group-hover:text-yellow-700">Announcement</span>
            <span class="text-xs text-gray-500 mt-1">Important notice</span>
        </button>

    </div>
</div>
    <!-- Scripts -->
    <script>
        // Store a global reference to the active HTMX modal instance
        window.htmxModalInstance = null;

        // Re-initialize Flowbite after HTMX swaps
        document.body.addEventListener('htmx:afterSwap', function (event) {
            if (window.initFlowbite) {
                // Check if the swap was into our htmx-modal-content
                if (event.detail.target.id === 'htmx-modal-content') {
                    const modalEl = document.getElementById('htmx-modal');
                    if (modalEl) {
                        // Define a unique ID for each modal instance to avoid conflicts
                        const instanceId = `htmx-modal-${Date.now()}`;
                        modalEl.setAttribute('data-modal-id', instanceId);

                        const modalOptions = {
                            placement: 'center',
                            backdrop: 'dynamic',
                            backdropClasses: 'bg-gray-900 bg-opacity-50 fixed inset-0 z-50',
                            closable: true,
                            onHide: () => {
                                // Clean up when modal is hidden, but restore a placeholder
                                // to prevent htmx:targetError on subsequent clicks.
                                const modalContent = document.getElementById('htmx-modal-content');
                                if (modalContent) {
                                    modalContent.innerHTML = `<div class="p-8 text-center"><p>Loading...</p></div>`;
                                }

                                // Flowbite's hide() method sometimes leaves the backdrop.
                                // This ensures the backdrop is removed.
                                document.querySelector(`[data-modal-backdrop="${instanceId}"]`)?.remove();
                            }
                        };
                        const modal = new Modal(modalEl, modalOptions, { id: instanceId, onHide: modalOptions.onHide });
                        window.htmxModalInstance = modal;
                        modal.show();
                    }
                }

                // General re-initialization for other components
                window.initFlowbite();
            }
        });

        // Pre-select post type in modal
        document.addEventListener('click', function (e) {
            const toggleButton = e.target.closest('[data-modal-toggle="create-post-modal"]');
            if (toggleButton && toggleButton.dataset.postType) {
                const postType = toggleButton.dataset.postType;
                const modal = document.getElementById('create-post-modal');
                if (modal) {
                    const postTypeSelect = modal.querySelector('select[name="post_type"]');
                    if (postTypeSelect) {
                        postTypeSelect.value = postType;
                    }
                }
            }
        });

        function toggleReplyForm(commentId) {
            const form = document.getElementById('reply-form-' + commentId);
            if (form) {
                form.classList.toggle('hidden');
                if (!form.classList.contains('hidden')) {
                    form.querySelector('textarea').focus();
                }
            }
        }

        function sharePost(button) {
            const postUrl = button.dataset.postUrl;
            const postTitle = button.dataset.postTitle;
            const shareText = button.querySelector('.share-text');
            const successText = button.querySelector('.share-success-text');

            if (navigator.share) {
                navigator.share({
                    title: postTitle,
                    text: `Check out this post on Chema!`,
                    url: postUrl,
                })
                    .then(() => console.log('Successful share'))
                    .catch((error) => console.log('Error sharing', error));
            } else {
                navigator.clipboard.writeText(postUrl).then(function () {
                    if (shareText && successText) {
                        shareText.classList.add('hidden');
                        successText.classList.remove('hidden');
                        setTimeout(() => {
                            shareText.classList.remove('hidden');
                            successText.classList.add('hidden');
                        }, 2000);
                    }
                }, function (err) {
                    console.error('Could not copy text: ', err);
                    alert('Failed to copy link.');
                });
            }
        }

        // CSRF token for HTMX
        document.body.addEventListener('htmx:configRequest', (event) => {
            const token = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
            event.detail.headers['X-CSRFToken'] = token;
        });

        // Lightbox JavaScript (from previous artifact)
        let currentPostMedia = [];
        let currentMediaIndex = 0;
        let currentPostId = null;

        function openLightbox(postId, startIndex) {
            collectPostMedia(postId);
            if (currentPostMedia.length === 0) return;

            currentMediaIndex = startIndex;
            currentPostId = postId;

            const lightbox = document.getElementById('media-lightbox');
            const prevBtn = document.getElementById('lightbox-prev');
            const nextBtn = document.getElementById('lightbox-next');

            if (currentPostMedia.length > 1) {
                prevBtn.classList.remove('hidden');
                nextBtn.classList.remove('hidden');
            } else {
                prevBtn.classList.add('hidden');
                nextBtn.classList.add('hidden');
            }

            loadMediaAtIndex(currentMediaIndex);
            lightbox.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        function collectPostMedia(postId) {
            currentPostMedia = [];
            const postContainer = document.querySelector(`[data-post-id="${postId}"]`);
            if (!postContainer) return;

            const mediaElements = postContainer.querySelectorAll('[data-media-url]');
            mediaElements.forEach(element => {
                currentPostMedia.push({
                    url: element.dataset.mediaUrl,
                    altText: element.dataset.mediaAlt || '',
                    type: element.dataset.mediaType || 'image',
                    caption: element.dataset.mediaCaption || ''
                });
            });
        }

        function loadMediaAtIndex(index) {
            if (index < 0 || index >= currentPostMedia.length) return;

            const media = currentPostMedia[index];
            const image = document.getElementById('lightbox-image');
            const video = document.getElementById('lightbox-video');
            const caption = document.getElementById('lightbox-caption');
            const counter = document.getElementById('lightbox-counter');
            const download = document.getElementById('lightbox-download');

            video.pause();
            video.currentTime = 0;

            if (media.type === 'image') {
                image.src = media.url;
                image.alt = media.altText;
                image.classList.remove('hidden');
                video.classList.add('hidden');
            } else if (media.type === 'video') {
                video.querySelector('source').src = media.url;
                video.load();
                video.classList.remove('hidden');
                image.classList.add('hidden');
            }

            caption.textContent = media.caption || media.altText || '';
            counter.textContent = currentPostMedia.length > 1 ? `${index + 1} / ${currentPostMedia.length}` : '';
            download.href = media.url;
            download.download = media.url.split('/').pop();
        }

        function closeLightbox() {
            const lightbox = document.getElementById('media-lightbox');
            const video = document.getElementById('lightbox-video');
            const image = document.getElementById('lightbox-image');

            video.pause();
            video.currentTime = 0;
            image.src = '';
            video.querySelector('source').src = '';

            lightbox.classList.add('hidden');
            document.body.style.overflow = 'auto';

            currentPostMedia = [];
            currentMediaIndex = 0;
            currentPostId = null;
        }

        function navigateLightbox(direction) {
            if (currentPostMedia.length === 0) return;
            currentMediaIndex = (currentMediaIndex + direction + currentPostMedia.length) % currentPostMedia.length;
            loadMediaAtIndex(currentMediaIndex);
        }

        // Keyboard navigation
        document.addEventListener('keydown', function (e) {
            const lightbox = document.getElementById('media-lightbox');
            if (!lightbox.classList.contains('hidden')) {
                e.preventDefault();
                if (e.key === 'Escape') closeLightbox();
                else if (e.key === 'ArrowLeft') navigateLightbox(-1);
                else if (e.key === 'ArrowRight') navigateLightbox(1);
            }
        });
    </script>
